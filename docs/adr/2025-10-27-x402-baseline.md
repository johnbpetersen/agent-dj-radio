# ADR: x402 Baseline Architecture

**Status:** Documented (Active)
**Date:** 2025-10-27
**Context:** Source of truth for current x402 payment implementation
**Related:** `docs/x402/2025-10-27-audit.md` (comprehensive analysis)

---

## Context

Agent DJ Radio is a web-based radio station where users submit AI-generated music tracks. To monetize and prevent spam, we implemented micropayments using the x402 protocol (HTTP 402 Payment Required) on Base Sepolia testnet.

**Requirements:**
- Payments under $1 USD (5-10 cents per track)
- Fast confirmation (<10 seconds)
- Low gas fees (L2 blockchain)
- Developer-friendly (wallet signature, no complex smart contract interaction)
- Works within Vercel Hobby plan (single serverless function)

**Constraints:**
- Must support web wallets (MetaMask, Coinbase Wallet)
- Testnet-first (mainnet later)
- Minimal external dependencies
- Idempotent payment confirmation

---

## Decisions

### 1. **Blockchain: Base Sepolia**

**Decision:** Use Base (Coinbase L2) on Sepolia testnet for initial rollout.

**Rationale:**
- **Low fees:** Base inherits Ethereum security with <$0.01 transaction costs
- **Fast finality:** ~2 seconds block time
- **USDC native:** Widely supported stablecoin
- **Developer ecosystem:** Good RPC availability, Coinbase wallet integration
- **Testnet available:** Base Sepolia allows free testing before mainnet

**Alternatives Considered:**
- **Ethereum mainnet:** Too expensive (~$5-50 gas per tx)
- **Polygon:** Considered, but Base has better Coinbase Wallet UX
- **Arbitrum:** Similar L2 benefits, but Base chosen for Coinbase ecosystem alignment

**Migration Path to Mainnet:**
- Change `X402_CHAIN=base` (remove `-sepolia`)
- Update `X402_RECEIVING_ADDRESS` to production wallet
- Configure CDP keys for Coinbase Commerce integration
- No code changes required

---

### 2. **Payment Protocol: x402 + ERC-3009**

**Decision:** Implement x402 protocol with ERC-3009 `TransferWithAuthorization` for gasless signatures.

**What is x402:**
- HTTP 402 status code "Payment Required"
- Response includes `X-PAYMENT` header with payment challenge
- Client signs authorization and submits proof to `/confirm` endpoint
- Server verifies payment and grants access

**Why ERC-3009:**
- **Gasless for recipient:** User signs message, facilitator handles on-chain submission
- **Replay protection:** Built-in nonce prevents reuse of same signature
- **Time-bound:** `validAfter` and `validBefore` timestamps limit validity window
- **Standard:** EIP-3009 is battle-tested (used by USDC transfers)

**Flow:**
```
1. Client: POST /queue/submit {prompt, duration}
2. Server: 402 Payment Required
   X-PAYMENT: payTo=0x...; amount=50000...; nonce=0x...; expiresAt=...
3. Client: Wallet signs ERC-3009 authorization (EIP-712 typed data)
4. Client: POST /queue/confirm {challengeId, authorization}
5. Server: Verify signature â†’ Mark track PAID â†’ Grant access
```

**Alternatives Considered:**
- **Direct on-chain transfer:** Requires user to pay gas (UX friction)
- **Payment channels:** Too complex for initial MVP
- **Coinbase Commerce:** Considered for mainnet (requires KYC)

---

### 3. **Verification Mode: Facilitator**

**Decision:** Use external facilitator service (`x402.org/facilitator`) for payment verification.

**How it Works:**
1. Server sends signed authorization to facilitator
2. Facilitator validates:
   - Signature matches expected signer (EIP-712 recovery)
   - Nonce not previously used (anti-replay)
   - Amount >= required
   - Recipient address matches
   - Time bounds valid
3. Facilitator returns `{valid: true}` or `{valid: false, error: "..."}`
4. Server trusts facilitator response and marks payment confirmed

**Advantages:**
- âœ… **Instant verification:** No waiting for on-chain TX mining
- âœ… **Nonce tracking:** Facilitator maintains nonce registry
- âœ… **No RPC dependency:** Server doesn't need to query blockchain
- âœ… **Gasless UX:** User only signs message, no TX broadcast

**Disadvantages:**
- âš ï¸ **External dependency:** If facilitator is down, payments fail
- âš ï¸ **Trust assumption:** Must trust facilitator to validate correctly
- âš ï¸ **Centralization:** Single point of failure

**Fallback Mode: RPC Direct Verification**
- Set `X402_MODE=rpc` to query blockchain directly
- Verifies on-chain transaction receipt
- More decentralized but requires TX to be mined first
- Used as backup if facilitator has extended outage

**Implementation Details:**
```typescript
// Retry strategy: 3 attempts with exponential backoff
const facilitatorUrl = 'https://x402.org/facilitator/verify'
const response = await fetch(facilitatorUrl, {
  method: 'POST',
  body: JSON.stringify({
    authorization: { signature, authorization: { from, to, value, nonce, ... } },
    expected: { to: X402_RECEIVING_ADDRESS, amount: challengeAmount }
  })
})
// Retries: 1s, 2s, 4s delays
```

---

### 4. **Database Schema: payment_challenges + payment_confirmations**

**Decision:** Use two tables for payment lifecycle with idempotency guarantees.

**Schema:**
```sql
-- One challenge per track submission
payment_challenges (
  challenge_id UUID PRIMARY KEY,
  track_id UUID REFERENCES tracks(id),
  user_id UUID,
  amount_atomic BIGINT,
  nonce TEXT NOT NULL,
  expires_at TIMESTAMPTZ,
  confirmed_at TIMESTAMPTZ
)

-- One confirmation per successful payment
payment_confirmations (
  id UUID PRIMARY KEY,
  challenge_id UUID UNIQUE,  -- Prevents double-confirmation
  tx_hash TEXT UNIQUE,       -- Prevents TX reuse
  provider TEXT,             -- 'facilitator' | 'rpc' | 'mock'
  amount_paid_atomic BIGINT
)
```

**Idempotency Enforcement:**
1. **`challenge_id UNIQUE`:** Same challenge can only be confirmed once
2. **`tx_hash UNIQUE`:** Same transaction cannot confirm two different challenges

**Query on Confirm:**
```sql
-- Check if already confirmed (idempotent)
SELECT * FROM payment_confirmations WHERE challenge_id = $1

-- If not, insert with conflict detection
INSERT INTO payment_confirmations (challenge_id, tx_hash, ...)
ON CONFLICT (challenge_id) DO NOTHING RETURNING *

-- Separate check for tx_hash reuse
ON CONFLICT (tx_hash) â†’ Return 409 TX_ALREADY_USED
```

**Why Not Single Table:**
- Separation of concerns: Challenges are temporary, confirmations are permanent
- Performance: Can delete expired challenges without affecting payment history
- Flexibility: Confirmations track provider metadata (facilitator response JSON)

---

### 5. **TTL & Expiry: 10 Minutes**

**Decision:** Payment challenges expire 10 minutes after creation.

**Rationale:**
- Prevents abandoned challenges from accumulating
- Forces fresh payment if user delays
- Mitigates replay attack window

**Implementation:**
```typescript
const TTL_SECONDS = 10 * 60 // 600 seconds
const expiresAt = new Date(Date.now() + TTL_SECONDS * 1000)

// On confirm:
const CLOCK_SKEW_MS = 60 * 1000 // Â±60s tolerance
if (Date.now() - CLOCK_SKEW_MS > new Date(challenge.expires_at).getTime()) {
  return { ok: false, code: 'EXPIRED' }
}
```

**Clock Skew Tolerance:**
- Allows Â±60 seconds difference between client/server clocks
- Prevents false positives from NTP drift

**Cleanup Strategy:**
- Background job (not yet implemented) to delete challenges older than 24 hours
- Recommendation: Add cron task or Supabase function

---

### 6. **Error Codes: Granular x402 Protocol**

**Decision:** Return specific error codes for each failure mode, following HTTP + x402 conventions.

**Error Code Design:**
```typescript
// Success
200 {paid: true, track_id, amount_paid_atomic}

// Client errors (400-level)
400 VALIDATION_ERROR    // Invalid request format
400 NO_MATCH            // Signature invalid or TX not found
400 EXPIRED             // Challenge TTL exceeded
400 WRONG_RECIPIENT     // Payment sent to wrong address
400 WRONG_CHAIN         // TX on different network
400 UNDERPAID           // Amount less than required
409 TX_ALREADY_USED     // TX hash used for different challenge

// Server errors (500-level)
503 PROVIDER_ERROR      // Facilitator/RPC unreachable
500 INTERNAL            // Unexpected server error
```

**Rationale:**
- **Actionable:** Each code tells client exactly what to fix
- **Idempotent-aware:** `ALREADY_PAID` returns 200 (not error)
- **Retry guidance:** 503 suggests retry, 400 errors are permanent
- **Monitoring:** Can track error rates by code

**Logging:**
```typescript
logger.info('Payment verification failed', {
  correlationId,
  challengeId,
  errorCode: 'WRONG_CHAIN',
  expected: 'base-sepolia',
  received: 'ethereum-mainnet'
})
```

---

### 7. **Rate Limiting: 60-Second Cooldown**

**Decision:** Enforce 60-second cooldown between track submissions per user.

**Implementation:**
```typescript
// In-memory cooldown tracker (resets on server restart)
const submitCooldowns = new Map<string, number>()

function checkSubmitCooldown({ userId }) {
  const lastSubmit = submitCooldowns.get(userId) || 0
  const elapsed = Date.now() - lastSubmit
  const cooldownMs = 60 * 1000

  if (elapsed < cooldownMs) {
    return {
      allowed: false,
      remainingSeconds: Math.ceil((cooldownMs - elapsed) / 1000)
    }
  }

  return { allowed: true }
}
```

**Why:**
- Prevents spam submissions
- Limits cost of generating free challenges
- Aligns with track generation time (~30-60s)

**Future Enhancement:**
- Move to Redis for distributed rate limiting across serverless instances
- Per-IP rate limiting for unauthenticated users

---

### 8. **Client Libraries**

**Decision:** Use Viem (v2.38.0) for blockchain interactions and @coinbase/wallet-sdk (v4.3.7) for wallet connection.

**Why Viem over Ethers.js:**
- Modern TypeScript-first design
- Smaller bundle size (~120KB vs ~300KB)
- Better tree-shaking
- Native EIP-712 support for typed data signing

**Why Coinbase Wallet SDK:**
- Seamless integration with Base chain
- Handles multi-provider injection (MetaMask + Coinbase both installed)
- Supports both injected provider and SDK mode

**Client Architecture:**
```typescript
// src/hooks/useWalletConnect.ts
const client = createWalletClient({
  chain: baseSepolia,
  transport: custom(window.ethereum)
})

// Sign ERC-3009 authorization
const signature = await client.signTypedData({
  domain: { name: 'USD Coin', version: '2', chainId: 84532, verifyingContract: USDC_ADDRESS },
  types: { TransferWithAuthorization: [...] },
  primaryType: 'TransferWithAuthorization',
  message: { from, to, value, validAfter, validBefore, nonce }
})
```

---

### 9. **Feature Flags**

**Decision:** Use environment-based feature flags for payment gating.

**Flags:**
```bash
ENABLE_X402=true|false           # Master switch
X402_MODE=facilitator|rpc|mock   # Verification strategy
ENABLE_MOCK_PAYMENTS=true|false  # Allow mock proofs (dev only)
```

**Behavior:**
- `ENABLE_X402=false` â†’ Submit creates PAID tracks (free mode, dev default)
- `ENABLE_X402=true` + `X402_MODE=facilitator` â†’ Production flow
- `ENABLE_X402=true` + `ENABLE_MOCK_PAYMENTS=true` â†’ Staging (allow mock tx for E2E tests)

**Guardrails:**
- `check-env.ts` should enforce `ENABLE_MOCK_PAYMENTS=false` in prod (not yet implemented)
- Mock mode endpoint (`/x402/mock-proofs`) returns 404 if flag disabled

---

## Consequences

### Positive

âœ… **Fast payments:** ERC-3009 + facilitator enables <5 second confirmation
âœ… **Low friction UX:** User only signs message, no gas payment required
âœ… **Idempotent:** Retry-safe, duplicate payments return success
âœ… **Testable:** Mock mode allows CI/CD without real blockchain
âœ… **Scalable:** Stateless serverless functions, horizontally scalable
âœ… **Observable:** Granular error codes + structured logging

### Negative

âš ï¸ **Testnet-only:** Not production-ready until mainnet config added
âš ï¸ **Facilitator dependency:** Centralized verification (mitigated by RPC fallback)
âš ï¸ **No automatic failover:** If facilitator down, manual switch to RPC mode required
âš ï¸ **Limited monitoring:** No dashboard for payment success rates yet

### Neutral

ðŸ”¹ **USDC-only:** Could support other ERC-20 tokens but USDC is sufficient for MVP
ðŸ”¹ **Base-only:** Could deploy to other L2s (Arbitrum, Optimism) with config change
ðŸ”¹ **10-minute TTL:** Arbitrary choice, could be configurable via env var

---

## Open Questions

1. **Mainnet RPC provider:** Alchemy vs Infura vs Coinbase Node for production?
2. **Facilitator SLA:** What is x402.org's uptime guarantee? Do we need self-hosted fallback?
3. **USDC decimals:** Current code uses 18 decimals (wei), but USDC has 6. Is amount calculation correct?
4. **Gas price alerts:** Should FE warn users about network congestion?
5. **Webhook support:** Should facilitator POST to our callback URL on payment success?
6. **Multi-asset future:** If we add ETH or other tokens, how to handle amount calculation?

---

## Recommendations

### Before Mainnet Launch

1. **Add env validation:** Update `scripts/check-env.ts` to FAIL if `X402_RECEIVING_ADDRESS` missing in prod
2. **RPC failover:** Add Alchemy/Infura as secondary RPC with automatic retry
3. **Increase confirmations:** Change RPC mode to require 3 block confirmations (reduce reorg risk)
4. **Audit USDC decimals:** Verify amount = `price_usd * 1e6` (not 1e18) for mainnet USDC
5. **Add monitoring:** Integrate metrics for success rate, latency, error distribution
6. **Document CDP keys:** Add guide for obtaining Coinbase Developer Platform credentials
7. **Staging test:** Run 100 test payments on Base Sepolia with real wallet signatures

### Post-Launch Enhancements

1. **Webhook callbacks:** Allow facilitator to push payment confirmations (reduce polling)
2. **Realtime status:** Add WebSocket subscription for track status updates
3. **Multi-chain:** Support Arbitrum/Optimism for geographic routing
4. **Gas estimation:** Show estimated gas cost in payment modal (even though user doesn't pay)
5. **Analytics dashboard:** Track payment funnel: submit â†’ 402 â†’ sign â†’ confirm â†’ success %

---

## References

**Internal:**
- Audit Report: `docs/x402/2025-10-27-audit.md`
- Error Codes Doc: `docs/x402-granular-codes-and-idempotency.md`
- Facilitator README: `api/_shared/payments/facilitator/README.md`

**External:**
- x402 Protocol: https://x402.org
- ERC-3009 Spec: https://eips.ethereum.org/EIPS/eip-3009
- Base Docs: https://docs.base.org
- Viem Docs: https://viem.sh
- USDC Contract (Base Sepolia): `0x036CbD53842c5426634e7929541eC2318f3dCF7e`

**Related ADRs:**
- None yet (this is first x402 ADR)

---

**Status:** This ADR documents the **current implemented state** as of 2025-10-27. It is **not a proposal**â€”these decisions are already in production (testnet). Any changes should be documented in a new ADR.

**Next Review:** Before mainnet migration or after 6 months (whichever comes first).

---

**Changelog:**
- **2025-10-27:** Initial documentation of baseline architecture
