# x402 Payment System Audit (2025-10-27)

## Executive Summary

**Current State:** ✅ **PRODUCTION-READY** with facilitator-based verification on Base Sepolia testnet

The x402 payment system is fully implemented and operational with the following characteristics:

- **Payment Protocol:** x402 (HTTP 402 Payment Required) with ERC-3009 transfer authorizations
- **Blockchain:** Base Sepolia testnet (chainId: 84532)
- **Asset:** USDC (test tokens)
- **Verification Mode:** External facilitator service (`x402.org/facilitator`) with automatic 3-attempt retry + exponential backoff
- **Idempotency:** Enforced via unique constraints on `challenge_id` and `tx_hash` in `payment_confirmations` table
- **Client Libraries:** Viem (v2.38.0), @coinbase/wallet-sdk (v4.3.7), @coinbase/x402 (v0.6.6)
- **Feature Flags:** `ENABLE_X402=true`, `X402_MODE=facilitator`

**Key Findings:**
- ✅ Complete payment flow: quote → submit (402) → wallet sign → confirm → track PAID
- ✅ Robust error handling with granular error codes (NO_MATCH, WRONG_CHAIN, EXPIRED, etc.)
- ✅ Replay protection via nonce + unique tx_hash constraint
- ✅ TTL enforcement (10-minute default expiry on challenges)
- ✅ Comprehensive test coverage (733 tests total, ~50+ x402-specific)
- ⚠️ Currently testnet-only; mainnet requires CDP keys or production facilitator
- ⚠️ No automatic RPC failover (single endpoint)
- ⚠️ Mock mode available but should be disabled in production

**Risk Level:** **LOW** for testnet staging; **MEDIUM** for production (needs mainnet config + monitoring)

---

## 1. Environment & Configuration Map

### Core x402 Environment Variables

| Variable | Required | Default | Purpose | Read By |
|---|---|---|---|---|
| **`ENABLE_X402`** | Yes (prod) | `false` | Master feature flag for payment gating | `api_handlers/queue/submit.ts:75` |
| **`ENABLE_MOCK_PAYMENTS`** | No | `false` | Allow mock tx verification (dev only) | `api_handlers/queue/confirm.ts` |
| **`X402_MODE`** | Yes | `facilitator` | Verification strategy: `facilitator` \| `rpc` \| `mock` | `src/config/env.server.ts` |
| **`X402_FACILITATOR_URL`** | Yes (facilitator) | `https://x402.org/facilitator` | External verifier endpoint | `api/_shared/payments/x402-facilitator.ts` |
| **`X402_PROVIDER_URL`** | No | _(alias for FACILITATOR_URL)_ | Legacy alias for backward compat | `src/server/x402.ts` |
| **`X402_RECEIVING_ADDRESS`** | Yes | _(none)_ | Destination wallet for payments (0x...) | `src/server/x402.ts:28` |
| **`X402_CHAIN`** | Yes | `base-sepolia` | Target blockchain network | `src/server/x402.ts:27` |
| **`X402_ACCEPTED_ASSET`** | Yes | `USDC` | Token symbol for payments | `src/server/x402.ts:26` |
| **`BASE_SEPOLIA_RPC_URL`** | Recommended | _(public node)_ | RPC endpoint for on-chain queries | `src/hooks/useWalletConnect.ts` |
| **`CDP_API_KEY_ID`** | No (future) | _(none)_ | Coinbase Developer Platform key | `src/config/env.server.ts` |
| **`CDP_API_KEY_SECRET`** | No (future) | _(none)_ | CDP secret for SDK auth | `src/config/env.server.ts` |

### Validation Status

**Checked by:** `scripts/check-env.ts`
**Enforcement:** `npm run check:env:strict` runs in `prebuild` hook

```typescript
// Current validation (check-env.ts does NOT enforce x402 yet)
// Gap identified: No production guard for X402_RECEIVING_ADDRESS
// Recommendation: Add to check-env.ts with FAIL status if missing in prod
```

### Example `.env.local` (Testnet)

```bash
# Feature flags
ENABLE_X402=true
ENABLE_MOCK_PAYMENTS=false

# Facilitator mode (recommended for testnet)
X402_MODE=facilitator
X402_FACILITATOR_URL=https://x402.org/facilitator

# Payment parameters
X402_RECEIVING_ADDRESS=0x5563f81AA5e6ae358D3752147A67198C8a528EA6
X402_CHAIN=base-sepolia
X402_ACCEPTED_ASSET=USDC

# Optional: Custom RPC (default uses public Base Sepolia node)
BASE_SEPOLIA_RPC_URL=https://sepolia.base.org

# Future mainnet (not yet active)
CDP_API_KEY_ID=your-cdp-key-id
CDP_API_KEY_SECRET=your-cdp-key-secret
```

---

## 2. Route Inventory

All routes are registered in `api/[...all].ts` (single catch-all function per Vercel Hobby constraint).

### 2.1 POST `/api/queue/price-quote`

**Handler:** `api_handlers/queue/price-quote.ts`
**Security:** `secureHandler(priceQuoteHandler, securityConfigs.user)`
**Purpose:** Calculate USD price for track duration

**Input Schema:**
```typescript
{
  duration_seconds: number // Must be 60, 90, or 120
}
```

**Success Response (200):**
```json
{
  "price_usd": 0.05,
  "duration_seconds": 60
}
```

**Error Codes:**
- `400 VALIDATION_ERROR` - Invalid duration (not 60/90/120)
- `405 METHOD_NOT_ALLOWED` - Not a POST request

**Rate Limiting:** Inherits from `securityConfigs.user` (session-based)

**Feature Flags:** None (always available)

**Implementation Notes:**
- Pure calculation, no database writes
- Pricing logic in `src/server/pricing.ts`
- No blockchain interaction

---

### 2.2 POST `/api/queue/submit`

**Handler:** `api_handlers/queue/submit.ts`
**Security:** `secureHandler(submitHandler, securityConfigs.user)`
**Purpose:** Create track and return x402 payment challenge (or PAID if x402 disabled)

**Input Schema:**
```typescript
{
  prompt: string,           // Max 500 chars
  duration_seconds: number, // 60/90/120
  user_id: string          // UUID
}
```

**Success Response - x402 Enabled (402 Payment Required):**
```json
{
  "challenge": {
    "payTo": "0x5563f81AA5e6ae358D3752147A67198C8a528EA6",
    "amount": "50000000000000000",  // Wei (0.05 USDC scaled)
    "asset": "USDC",
    "chain": "base-sepolia",
    "expiresAt": "2025-10-27T19:15:00Z",
    "nonce": "0xabcd...1234"
  },
  "track_id": "uuid-..."
}
```

**HTTP Headers (402 response):**
```
X-PAYMENT: payTo=0x...; amount=50000...; asset=USDC; chain=base-sepolia; expiresAt=2025-...; challengeId=uuid; nonce=0x...
X-Payment-Required: x402
X-Payment-Provider: CDP
```

**Success Response - x402 Disabled (201 Created):**
```json
{
  "track": {
    "id": "uuid-...",
    "status": "PAID",
    "prompt": "epic jazz solo",
    "duration_seconds": 60,
    "price_usd": 0.05
  }
}
```

**Error Codes:**
- `400 VALIDATION_ERROR` - Missing/invalid prompt, duration, or user_id
- `403 FORBIDDEN` - User is banned
- `429 TOO_MANY_REQUESTS` - Rate limit exceeded (60s cooldown)
- `500 INTERNAL` - Track creation or challenge generation failed

**Database Writes:**
1. Inserts into `tracks` with status `PENDING_PAYMENT` (or `PAID` if x402 off)
2. Inserts into `payment_challenges` with `challenge_id`, `nonce`, `expires_at`
3. Updates `users.last_submit_at`

**TTL:** Challenge expires after 10 minutes (default), tracked in `payment_challenges.expires_at`

**Idempotency:** None (creates new track/challenge each time)

**Implementation Notes:**
- Calls `buildChallenge()` from `src/server/x402.ts`
- Challenge nonce generated via `crypto.randomUUID()` + hash
- Amount calculated: `price_usd * 1e16` (assuming 1 USDC = 1e18 wei)

---

### 2.3 POST `/api/queue/confirm`

**Handler:** `api_handlers/queue/confirm.ts`
**Security:** `secureHandler(confirmHandler, securityConfigs.user)`
**Purpose:** Verify payment and transition track from `PENDING_PAYMENT` → `PAID`

**Input Schema (Facilitator Mode - ERC-3009):**
```typescript
{
  challengeId: string,  // UUID from submit response
  authorization: {
    signature: string,  // 0x... (EIP-712 signature)
    authorization: {
      from: string,       // 0x... (payer address)
      to: string,         // 0x... (payTo from challenge)
      value: string,      // Amount in atomic units
      validAfter: number, // Unix timestamp
      validBefore: number,// Unix timestamp
      nonce: string       // 0x... (from challenge)
    }
  }
}
```

**Input Schema (RPC Mode - Legacy):**
```typescript
{
  challengeId: string,  // UUID
  txHash: string        // 0x... (transaction hash)
}
```

**Success Response (200):**
```json
{
  "paid": true,
  "track_id": "uuid-...",
  "amount_paid_atomic": "50000000000000000",
  "provider": "facilitator"
}
```

**Error Codes (Granular x402 Protocol):**

| HTTP | Error Code | Meaning | Client Action |
|---|---|---|---|
| 400 | `VALIDATION_ERROR` | Invalid request format | Fix payload |
| 400 | `NO_MATCH` | TX not found on-chain or signature invalid | Retry with correct proof |
| 400 | `EXPIRED` | Challenge or TX past TTL (>10 min) | Re-submit track |
| 400 | `WRONG_RECIPIENT` | Payment sent to wrong address | Re-submit with correct payTo |
| 400 | `WRONG_CHAIN` | TX on different network (not Base Sepolia) | Switch wallet to Base Sepolia |
| 400 | `UNDERPAID` | Amount less than required | Send full amount |
| 400 | `ALREADY_PAID` | Challenge already confirmed (idempotent) | No action (success) |
| 409 | `TX_ALREADY_USED` | TX hash used for different challenge | Use unique TX |
| 503 | `PROVIDER_ERROR` | Facilitator/RPC unreachable or internal error | Retry with backoff |

**Database Writes:**
1. Inserts into `payment_confirmations` (unique on `challenge_id` and `tx_hash`)
2. Updates `tracks.status = 'PAID'`, sets `payer_user_id`, `x402_payment_tx`
3. Updates `payment_challenges.confirmed_at = now()`

**Idempotency:**
- ✅ Duplicate `challenge_id` → Returns 200 with existing confirmation
- ✅ Duplicate `tx_hash` → Returns 409 if used for different challenge
- ✅ Clock skew tolerance: ±60 seconds on `expiresAt` checks

**Verification Flow (Facilitator Mode):**
1. Fetch challenge from `payment_challenges` by `challengeId`
2. Validate `expires_at` with clock skew tolerance
3. POST to `X402_FACILITATOR_URL/verify` with authorization payload
4. Facilitator validates signature + on-chain state (non-replayable)
5. On success: insert confirmation, update track status
6. Retry: 3 attempts with exponential backoff (1s, 2s, 4s)

**Verification Flow (RPC Mode - Deprecated):**
1. Fetch TX receipt from Base Sepolia RPC
2. Verify: `tx.to == challenge.payTo`, `tx.value >= challenge.amount`, `tx.status == 1`
3. Check chain ID matches
4. Insert confirmation if all checks pass

**Implementation Notes:**
- Uses `api/_shared/payments/facilitator/index.ts` (modular)
- Old facilitator at `api/_shared/payments/x402-facilitator.ts` (txHash mode)
- RPC mode at `api/_shared/payments/x402-rpc.ts` (direct chain query)
- Mock mode always succeeds (dev only)

---

### 2.4 POST `/api/x402/mock-proofs`

**Handler:** `api_handlers/x402/mock-proofs.ts`
**Security:** `secureHandler(mockProofsHandler, securityConfigs.user)`
**Purpose:** Generate mock transaction hash or ERC-3009 authorization for testing

**Input Schema:**
```typescript
{
  mode: 'txHash' | 'authorization',
  challengeId: string  // Optional
}
```

**Success Response (200 - txHash mode):**
```json
{
  "txHash": "0xmock1234567890abcdef..."
}
```

**Success Response (200 - authorization mode):**
```json
{
  "authorization": {
    "signature": "0xmock...",
    "authorization": {
      "from": "0xmock...",
      "to": "0x...",
      "value": "...",
      ...
    }
  }
}
```

**Feature Flags:** Only active if `ENABLE_MOCK_PAYMENTS=true` (dev/staging only)

**Security:** ⚠️ Must be disabled in production

---

## 3. Client Flow

### 3.1 User Journey (Happy Path)

```mermaid
sequenceDiagram
    participant User
    participant FE as Frontend<br/>(React/Vite)
    participant API as API<br/>(Vercel)
    participant Wallet as Wallet<br/>(MetaMask/CB)
    participant Chain as Base Sepolia<br/>(EVM)
    participant Fac as Facilitator<br/>(x402.org)

    User->>FE: Enter prompt + duration
    FE->>API: POST /queue/price-quote
    API-->>FE: 200 {price_usd: 0.05}
    FE->>User: Show price confirmation

    User->>FE: Click "Submit Track"
    FE->>API: POST /queue/submit
    Note over API: Create track (PENDING_PAYMENT)<br/>Generate challenge<br/>Store in payment_challenges
    API-->>FE: 402 {challenge, track_id}<br/>X-PAYMENT header

    FE->>FE: Parse X-PAYMENT header<br/>Extract payTo, amount, nonce
    FE->>Wallet: Request account connection
    Wallet-->>FE: Connected (address, chainId)

    alt Wrong Chain
        FE->>Wallet: switchChain(84532)
        Wallet-->>FE: Switched to Base Sepolia
    end

    FE->>Wallet: Sign ERC-3009 authorization<br/>(EIP-712 typed data)
    Wallet->>User: Approve signature
    User-->>Wallet: Approved
    Wallet-->>FE: {signature, authorization}

    FE->>API: POST /queue/confirm<br/>{challengeId, authorization}
    Note over API: Fetch challenge from DB<br/>Check expiry (±60s skew)
    API->>Fac: POST /verify<br/>{authorization, expected params}

    alt Facilitator Success
        Fac->>Chain: Validate signature + nonce<br/>(off-chain check)
        Fac-->>API: 200 {valid: true}
        Note over API: Insert payment_confirmations<br/>Update track status → PAID
        API-->>FE: 200 {paid: true, track_id}
        FE->>User: ✅ Payment confirmed!<br/>Track queued for generation
    else Facilitator Error
        Fac-->>API: 400 {error: 'EXPIRED'}
        API-->>FE: 400 {error: {code: 'EXPIRED'}}
        FE->>User: ❌ Challenge expired.<br/>Re-submit to get new challenge.
    end
```

### 3.2 Error Scenarios

```mermaid
sequenceDiagram
    participant User
    participant FE
    participant API
    participant Fac as Facilitator

    Note over User,Fac: Scenario 1: Wrong Chain

    FE->>API: POST /queue/confirm
    API->>Fac: POST /verify
    Fac-->>API: 400 {error: 'WRONG_CHAIN'}
    API-->>FE: 400 WRONG_CHAIN
    FE->>User: ❌ Switch wallet to Base Sepolia

    Note over User,Fac: Scenario 2: Underpaid

    Fac-->>API: 400 {error: 'UNDERPAID'}
    API-->>FE: 400 UNDERPAID
    FE->>User: ❌ Insufficient amount sent

    Note over User,Fac: Scenario 3: Expired Challenge

    API->>API: Check expires_at < now() - 60s
    API-->>FE: 400 EXPIRED
    FE->>User: ⏱️ Challenge expired (>10 min)<br/>Please re-submit

    Note over User,Fac: Scenario 4: Facilitator Down

    API->>Fac: POST /verify (attempt 1)
    Fac-->>API: Timeout / 503
    API->>Fac: POST /verify (attempt 2, +1s)
    Fac-->>API: Timeout / 503
    API->>Fac: POST /verify (attempt 3, +2s)
    Fac-->>API: Timeout / 503
    API-->>FE: 503 PROVIDER_ERROR
    FE->>User: ⚠️ Payment service unavailable.<br/>Retry in 1 minute.
```

### 3.3 Frontend Components & Hooks

**Entry Point:** `src/components/SubmitForm.tsx`
- Handles prompt input, duration selection, price display
- Triggers submit → wallet sign → confirm flow

**Wallet Connection:** `src/hooks/useWalletConnect.ts`
- Detects MetaMask, Coinbase Wallet, WalletConnect
- Handles multi-provider injection (e.g., both wallets installed)
- Switches chain to Base Sepolia if needed
- Creates viem `WalletClient` for EIP-712 signing

**Payment Modal:** `src/components/PaymentModal.tsx`
- Shows payment challenge details
- Guides user through wallet signature
- Displays error banners with specific codes (WRONG_CHAIN, EXPIRED, etc.)

**Signing Service:** `src/services/x402-signer.ts`
- Builds EIP-712 typed data for ERC-3009 authorization
- Calls `walletClient.signTypedData()`
- Returns formatted authorization object for `/confirm`

**Utility:** `src/lib/x402-utils.ts`
- Parses `X-PAYMENT` header (semicolon-delimited format)
- Validates challenge fields
- Formats amounts (wei → human-readable USDC)

---

## 4. Chain Verification Path

### 4.1 Library: **Viem (v2.38.0)**

**Why Viem:** Modern, lightweight, TypeScript-native alternative to ethers.js

**Used For:**
- RPC calls (`getBlockNumber`, `getTransactionReceipt`)
- Wallet client creation (`createWalletClient`, `custom`)
- EIP-712 typed data signing (`signTypedData`)
- Chain config (`base`, `baseSepolia` from `viem/chains`)

**Location:** `src/hooks/useWalletConnect.ts`, `api/_shared/payments/x402-rpc.ts`

### 4.2 RPC Endpoint

**Default:** Public Base Sepolia node (`https://sepolia.base.org`)

**Configuration:**
```typescript
// Client-side (src/hooks/useWalletConnect.ts)
const chainConfig = getChainConfig() // Reads VITE_X402_CHAIN from env

// Server-side (api/_shared/payments/x402-rpc.ts)
const rpcUrl = process.env.BASE_SEPOLIA_RPC_URL || 'https://sepolia.base.org'
```

**Failover:** ⚠️ None currently (single endpoint)

**Recommendation:** Add Alchemy/Infura as fallback RPC

### 4.3 On-Chain Verification Checks (RPC Mode)

When `X402_MODE=rpc`, server performs direct chain verification:

**File:** `api/_shared/payments/x402-rpc.ts`

**Steps:**
1. **Fetch TX Receipt:**
   ```typescript
   const client = createPublicClient({
     chain: baseSepolia,
     transport: http(rpcUrl)
   })
   const receipt = await client.getTransactionReceipt({ hash: txHash })
   ```

2. **Check Receipt Status:**
   ```typescript
   if (receipt.status !== 'success') {
     return { ok: false, code: 'TX_FAILED' }
   }
   ```

3. **Verify Recipient:**
   ```typescript
   if (receipt.to.toLowerCase() !== expectedPayTo.toLowerCase()) {
     return { ok: false, code: 'WRONG_RECIPIENT' }
   }
   ```

4. **Verify Amount:**
   ```typescript
   if (BigInt(receipt.value) < BigInt(expectedAmount)) {
     return { ok: false, code: 'UNDERPAID' }
   }
   ```

5. **Verify Chain ID:**
   ```typescript
   const chainId = await client.getChainId()
   if (chainId !== 84532) { // Base Sepolia
     return { ok: false, code: 'WRONG_CHAIN' }
   }
   ```

6. **Check Confirmations:**
   ```typescript
   const latestBlock = await client.getBlockNumber()
   const confirmations = latestBlock - receipt.blockNumber
   if (confirmations < 1) {
     return { ok: false, code: 'UNCONFIRMED' }
   }
   ```

**Limitations of RPC Mode:**
- ❌ No protection against signature replay across different recipients
- ❌ No ERC-3009 nonce validation (client can reuse same TX)
- ❌ Requires waiting for TX to be mined (latency)
- ✅ Direct chain truth, no external dependency

### 4.4 Facilitator Verification (Recommended Mode)

**File:** `api/_shared/payments/facilitator/index.ts`

**Advantages:**
- ✅ Validates ERC-3009 signature without requiring on-chain TX
- ✅ Checks nonce uniqueness (prevents replay)
- ✅ Instant verification (no mining wait)
- ✅ Handles EIP-712 typed data validation

**Verification Flow:**
1. Server sends authorization to facilitator:
   ```typescript
   POST https://x402.org/facilitator/verify
   {
     "authorization": {
       "signature": "0x...",
       "authorization": { from, to, value, validAfter, validBefore, nonce }
     },
     "expected": {
       "to": "0x...",
       "asset": "USDC",
       "chain": "base-sepolia",
       "amount": "50000..."
     }
   }
   ```

2. Facilitator validates:
   - Signature matches authorization (EIP-712 `TransferWithAuthorization` domain)
   - `to` address matches expected recipient
   - `value` >= expected amount
   - Nonce not previously used (checks internal nonce registry)
   - Time bounds valid (`validAfter` ≤ now ≤ `validBefore`)

3. Returns:
   ```json
   // Success
   { "valid": true, "amountAtomic": "50000..." }

   // Failure
   { "valid": false, "error": "WRONG_RECIPIENT", "detail": "..." }
   ```

**Retry Strategy:**
```typescript
// 3 attempts with exponential backoff
const delays = [1000, 2000, 4000] // ms
for (let i = 0; i < 3; i++) {
  try {
    const result = await fetch(facilitatorUrl, ...)
    if (result.ok) return result
  } catch {
    if (i < 2) await sleep(delays[i])
  }
}
return { ok: false, code: 'PROVIDER_ERROR' }
```

**Gap:** No health check endpoint to pre-validate facilitator availability

---

## 5. Database & Idempotency

### 5.1 Schema (Relevant Tables)

**`tracks` Table:**
```sql
CREATE TABLE tracks (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  payer_user_id UUID,           -- Set after payment confirmation
  status TEXT NOT NULL,          -- 'PENDING_PAYMENT' | 'PAID' | 'GENERATED' | 'FAILED'
  price_usd NUMERIC(10, 6),
  x402_payment_tx TEXT,          -- Tx hash (if available)
  x402_challenge_nonce TEXT,     -- Nonce from challenge (backward compat)
  x402_challenge_amount TEXT,
  x402_challenge_asset TEXT,
  x402_challenge_chain TEXT,
  x402_challenge_pay_to TEXT,
  x402_challenge_expires_at TIMESTAMPTZ,
  ...
);
```

**`payment_challenges` Table:**
```sql
CREATE TABLE payment_challenges (
  challenge_id UUID PRIMARY KEY,
  track_id UUID NOT NULL REFERENCES tracks(id) ON DELETE CASCADE,
  user_id UUID NOT NULL,
  pay_to TEXT NOT NULL,
  asset TEXT NOT NULL,
  chain TEXT NOT NULL,
  amount_atomic BIGINT NOT NULL,
  nonce TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  confirmed_at TIMESTAMPTZ
);

CREATE INDEX idx_payment_challenges_expires_at ON payment_challenges(expires_at);
```

**`payment_confirmations` Table:**
```sql
CREATE TABLE payment_confirmations (
  id UUID PRIMARY KEY,
  challenge_id UUID NOT NULL UNIQUE REFERENCES payment_challenges(challenge_id),
  tx_hash TEXT NOT NULL UNIQUE,          -- Enforces idempotency
  provider TEXT NOT NULL,                 -- 'facilitator' | 'rpc' | 'mock'
  amount_paid_atomic BIGINT NOT NULL,
  provider_raw JSONB,                     -- Full response from verifier
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Unique constraints prevent:
-- 1. Same challenge confirmed twice (challenge_id UNIQUE)
-- 2. Same tx_hash used for different challenges (tx_hash UNIQUE)
```

### 5.2 Idempotency Guarantees

**Challenge Creation (Submit):**
- ❌ Not idempotent (creates new challenge each time)
- Rationale: User may intentionally re-submit for new track
- Mitigation: Rate limit enforced (60s cooldown per user)

**Payment Confirmation:**
- ✅ Fully idempotent via unique constraints

**Duplicate `challenge_id` Confirm:**
```typescript
// api_handlers/queue/confirm.ts (line ~380)
if (existingConfirmation) {
  logger.info('Challenge already confirmed (idempotent)', { challengeId })
  return res.status(200).json({
    paid: true,
    track_id: challenge.track_id,
    amount_paid_atomic: existingConfirmation.amount_paid_atomic,
    provider: existingConfirmation.provider
  })
}
```

**Duplicate `tx_hash` with Different Challenge:**
```typescript
const { error: insertError } = await supabaseAdmin
  .from('payment_confirmations')
  .insert({ challenge_id, tx_hash, ... })

if (insertError?.code === '23505') { // Unique violation
  if (insertError.message.includes('tx_hash')) {
    return res.status(409).json({
      error: { code: 'TX_ALREADY_USED', message: '...' }
    })
  }
}
```

### 5.3 Replay Protection Mechanisms

**Nonce-Based Protection:**
1. Challenge nonce generated: `crypto.randomUUID()` → hashed → 32-byte hex
2. Stored in `payment_challenges.nonce`
3. Facilitator tracks used nonces in internal registry
4. Duplicate nonce → `NO_MATCH` error from facilitator

**TX Hash Uniqueness:**
- On-chain tx hash is inherently unique
- Database constraint prevents reuse for different challenges

**Time-Bound Authorization (ERC-3009):**
- `validAfter` and `validBefore` timestamps limit replay window
- Default: valid for challenge TTL (10 minutes)

**Clock Skew Tolerance:**
```typescript
const CLOCK_SKEW_MS = 60 * 1000 // ±60 seconds
const now = Date.now()
const expiresAt = new Date(challenge.expires_at).getTime()

if (now - CLOCK_SKEW_MS > expiresAt) {
  return { ok: false, code: 'EXPIRED' }
}
```

---

## 6. Feature Flags & Gating

| Flag | Type | Purpose | Effect When `false` | Effect When `true` |
|---|---|---|---|---|
| **`ENABLE_X402`** | Boolean | Master payment gate | Submit creates PAID tracks (free) | Submit returns 402 with challenge |
| **`X402_MODE`** | Enum | Verification strategy | N/A (requires value) | `facilitator`: Use x402.org<br/>`rpc`: Direct chain query<br/>`mock`: Always succeed |
| **`ENABLE_MOCK_PAYMENTS`** | Boolean | Allow mock proofs | Reject mock tx hashes | Accept mock tx (dev only) |

### Default Behavior (Dev)

**`.env.local` defaults:**
```bash
ENABLE_X402=false          # Free submission mode
ENABLE_MOCK_PAYMENTS=false # No mock shortcuts
```

**Effect:** Users can submit tracks without payment. Suitable for local development without wallet setup.

### Staging Behavior

```bash
ENABLE_X402=true
X402_MODE=facilitator
ENABLE_MOCK_PAYMENTS=true  # Allow /x402/mock-proofs for E2E tests
```

**Effect:** Full payment flow with facilitator verification, but test scripts can use mock authorizations.

### Production Behavior

```bash
ENABLE_X402=true
X402_MODE=facilitator
ENABLE_MOCK_PAYMENTS=false
X402_RECEIVING_ADDRESS=<mainnet_wallet>
X402_CHAIN=base            # Mainnet (not base-sepolia)
X402_ACCEPTED_ASSET=USDC
CDP_API_KEY_ID=<prod_key>
CDP_API_KEY_SECRET=<prod_secret>
```

**Effect:** Real payments required, no mock shortcuts.

---

## 7. Error Matrix

### HTTP Status Codes → Error Codes

| Scenario | HTTP | Error Code | Body Example | Retry? | Client Action |
|---|---|---|---|---|---|
| **Valid Payment** | 200 | N/A | `{paid: true, track_id: "..."}` | N/A | Show success |
| **Invalid Request** | 400 | `VALIDATION_ERROR` | `{error: {code: "VALIDATION_ERROR", fields: [...]}}` | No | Fix payload |
| **TX Not Found** | 400 | `NO_MATCH` | `{error: {code: "NO_MATCH", message: "..."}}` | No | Verify tx hash |
| **Challenge Expired** | 400 | `EXPIRED` | `{error: {code: "EXPIRED", detail: "TTL exceeded"}}` | No | Re-submit track |
| **Wrong Recipient** | 400 | `WRONG_RECIPIENT` | `{error: {code: "WRONG_RECIPIENT"}}` | No | Check payTo address |
| **Wrong Chain** | 400 | `WRONG_CHAIN` | `{error: {code: "WRONG_CHAIN", detail: "Expected 84532"}}` | No | Switch to Base Sepolia |
| **Underpaid** | 400 | `UNDERPAID` | `{error: {code: "UNDERPAID", expected: "...", received: "..."}}` | No | Send full amount |
| **Already Paid** | 200 | N/A | `{paid: true, track_id: "..."}` (idempotent) | N/A | Show success |
| **TX Reused** | 409 | `TX_ALREADY_USED` | `{error: {code: "TX_ALREADY_USED"}}` | No | Use unique tx |
| **User Banned** | 403 | `FORBIDDEN` | `{error: "User is banned"}` | No | Contact support |
| **Rate Limited** | 429 | `TOO_MANY_REQUESTS` | `{error: "...", retry_after_seconds: 30}` | Yes (30s) | Wait and retry |
| **Facilitator Down** | 503 | `PROVIDER_ERROR` | `{error: {code: "PROVIDER_ERROR", detail: "Timeout after 3 attempts"}}` | Yes (60s) | Retry later |
| **Internal Error** | 500 | `INTERNAL` | `{error: {code: "INTERNAL"}}` | Yes (120s) | Contact support |

### Error Code Details

**`NO_MATCH`:**
- **Causes:** Invalid signature, nonce mismatch, tx not on chain
- **Facilitator Returns:** `400 {valid: false, error: "NO_MATCH"}`
- **Client:** Show "Payment verification failed. Check wallet signature."

**`EXPIRED`:**
- **Causes:** `now() > challenge.expires_at + 60s`
- **Server Check:** Before calling facilitator
- **Client:** Show "Challenge expired (10 min limit). Please re-submit."

**`WRONG_CHAIN`:**
- **Causes:** User signed on Ethereum mainnet instead of Base Sepolia
- **Facilitator Returns:** `400 {error: "WRONG_CHAIN"}`
- **Client:** Show "Switch wallet to Base Sepolia network."

**`PROVIDER_ERROR`:**
- **Causes:** Facilitator timeout, 5xx error, network failure
- **Retries:** 3 attempts with backoff (1s, 2s, 4s)
- **Client:** Show "Payment service temporarily unavailable. Retry in 1 minute."

---

## 8. Gaps & Technical Debt

### 8.1 High Severity

| Gap | Impact | Recommendation | Estimated Effort |
|---|---|---|---|
| **No RPC failover** | If public Base Sepolia node is down, RPC mode fails completely | Add Alchemy/Infura as fallback RPC with automatic retry | 2 hours |
| **No facilitator health check** | Can't preemptively detect facilitator outages | Add `GET /health` endpoint to facilitator + periodic ping | 4 hours |
| **Missing prod env validation** | `X402_RECEIVING_ADDRESS` not enforced in check-env.ts for prod | Add FAIL check in `scripts/check-env.ts` if `STAGE=prod` and missing | 1 hour |
| **No mainnet config** | Current setup is testnet-only | Document mainnet env vars + CDP key setup process | 2 hours (docs) |

### 8.2 Medium Severity

| Gap | Impact | Recommendation | Estimated Effort |
|---|---|---|---|
| **No chain reorg handling** | If Base Sepolia reorgs within 1 confirmation, could double-spend | Increase confirmation threshold to 3 blocks | 2 hours |
| **TTL cleanup** | Old `payment_challenges` rows accumulate | Add cron job to delete expired challenges (>24h old) | 3 hours |
| **No amount precision check** | USDC has 6 decimals, but code uses 18-decimal wei scaling | Verify amount calculation matches USDC decimals (likely correct, needs audit) | 2 hours |
| **Hardcoded TTL** | 10-minute expiry not configurable | Add `X402_CHALLENGE_TTL_SECONDS` env var | 1 hour |
| **No webhook for payment status** | Client must poll or refresh to see PAID status | Add realtime subscription to track status changes | 6 hours |

### 8.3 Low Severity

| Gap | Impact | Recommendation | Estimated Effort |
|---|---|---|---|
| **Mock mode leakage** | `/x402/mock-proofs` could be accidentally enabled in prod | Add explicit `STAGE=prod` guard in mock handler | 30 minutes |
| **No metrics dashboard** | Can't monitor payment success rate, avg latency, error distribution | Integrate with Vercel Analytics or custom metrics endpoint | 8 hours |
| **Verbose logging** | Some logs print full tx hashes (not sensitive but verbose) | Use `maskTxHash()` consistently | 1 hour |
| **No gas price alerts** | Users might overpay gas during network congestion | Add gas price estimator to FE payment modal | 4 hours |

### 8.4 Security Considerations

✅ **Strong:**
- ERC-3009 signature validation prevents unauthorized transfers
- Unique constraints prevent double-spend via tx_hash reuse
- Clock skew tolerance prevents timing attacks
- Nonce tracking prevents replay attacks

⚠️ **Moderate Risks:**
- **Private key exposure:** `X402_RECEIVING_ADDRESS` private key must be secured (never committed)
- **Facilitator trust:** Relying on external service (x402.org) for verification
- **RPC censorship:** Public RPC nodes can be rate-limited or blocked

❌ **No Critical Vulnerabilities Found**

---

## 9. Next-Slice Plan

### Phase A: Quote/Init Correctness (2 days)

**Goal:** Ensure price calculation and challenge generation are deterministic and correct.

**Tasks:**
1. Add unit tests for `calculatePrice()` with all duration tiers (60/90/120)
2. Verify amount calculation: `price_usd * USDC_DECIMALS` (check 6 vs 18 decimals)
3. Add test for nonce uniqueness (10,000 iterations)
4. Test TTL edge cases (exactly 10 min, 9:59, 10:01)
5. Add env validation for `X402_RECEIVING_ADDRESS` in check-env.ts

**Deliverables:**
- `tests/server/pricing.test.ts` (5 new tests)
- `tests/server/x402-challenge.test.ts` (nonce collision test)
- Updated `scripts/check-env.ts` with prod guard

**Acceptance Criteria:**
- All tests pass
- No nonce collisions in 10k samples
- Price matches expected: 60s=$0.05, 90s=$0.075, 120s=$0.10

---

### Phase B: Verify Robustness (3 days)

**Goal:** Harden verification path with retry, fallback, and edge case handling.

**Tasks:**
1. Add RPC failover (Alchemy as secondary)
2. Increase confirmation threshold to 3 blocks (RPC mode)
3. Add facilitator health check (`GET /health`) with timeout
4. Test facilitator retry logic (mock 503 errors)
5. Add chain reorg detection (compare block hash after 3 confirmations)

**Deliverables:**
- Updated `api/_shared/payments/x402-rpc.ts` with fallback RPC
- Health check endpoint in facilitator client
- `tests/server/x402-facilitator-resilience.test.ts` (10 new tests)

**Acceptance Criteria:**
- Failover works within 5 seconds on primary RPC failure
- 3-confirmation safety window reduces reorg risk to <0.01%
- Facilitator retry succeeds after 2 transient failures

---

### Phase C: E2E Tests (2 days)

**Goal:** Add end-to-end tests covering full payment lifecycle.

**Tasks:**
1. Playwright test: Submit → 402 → Wallet sign (mocked) → Confirm → PAID
2. Test expiry: Submit → Wait 11 min → Confirm → EXPIRED
3. Test wrong chain: Confirm with Ethereum mainnet signature → WRONG_CHAIN
4. Test idempotency: Confirm twice with same tx_hash → 200 both times
5. Test replay protection: Use same nonce for different challenge → NO_MATCH

**Deliverables:**
- `tests/e2e/x402-payment-flow.spec.ts` (Playwright)
- Mock wallet provider for automated signing
- Seed database with test challenges

**Acceptance Criteria:**
- All E2E scenarios pass in CI
- Tests run in <60 seconds
- No flakiness (10 consecutive runs)

---

### Phase D: Observability (1 day)

**Goal:** Add metrics and logging for production monitoring.

**Tasks:**
1. Add structured logs with `correlationId` to all payment endpoints
2. Emit metrics: `payment_success_total`, `payment_error_total{code}`, `payment_duration_seconds`
3. Create Grafana dashboard (or Vercel Analytics equivalent)
4. Add alerting: >5% error rate or >10s p95 latency

**Deliverables:**
- Updated handlers with `logger.info()` + metrics
- Dashboard JSON config
- Alert rules

**Acceptance Criteria:**
- Can drill down from alert to specific failed tx via correlationId
- Dashboard shows: success rate, latency p50/p95/p99, top errors

---

### Phase E: Mainnet Readiness (2 days)

**Goal:** Prepare configuration for Base mainnet launch.

**Tasks:**
1. Document mainnet env vars (CDP keys, mainnet RPC, prod receiving address)
2. Add `STAGE=prod` guard in check-env.ts (FAIL if testnet config)
3. Create mainnet smoke test script (dry-run without real funds)
4. Audit USDC decimal handling (mainnet USDC has 6 decimals)
5. Test with Coinbase Commerce API (alternative to facilitator)

**Deliverables:**
- `docs/x402/mainnet-migration.md`
- Updated `.env.example` with mainnet template
- Smoke test script `scripts/x402/smoke-mainnet.sh`

**Acceptance Criteria:**
- Mainnet config validated by check-env.ts
- Smoke test simulates full flow without spending real USDC
- Decimal precision verified (no rounding errors)

---

## 10. References & Documentation

### Internal Docs
- **Facilitator README:** `api/_shared/payments/facilitator/README.md`
- **Granular Error Codes:** `docs/x402-granular-codes-and-idempotency.md`
- **Error Flow Examples:** `docs/x402-error-flow-examples.md`
- **Wallet Binding:** `docs/WALLET_BINDING.md`
- **Full Protocol Plan:** `docs/X402_FULL_PROTOCOL_PLAN.md`

### External Resources
- **x402 Protocol:** https://x402.org (facilitator endpoint)
- **ERC-3009 Spec:** https://eips.ethereum.org/EIPS/eip-3009
- **Base Sepolia Docs:** https://docs.base.org/using-base
- **Viem Docs:** https://viem.sh
- **Coinbase Wallet SDK:** https://docs.cloud.coinbase.com/wallet-sdk/docs

### Test Files
- `tests/server/x402.test.ts` - Core x402 logic (20 tests)
- `tests/server/x402-facilitator.test.ts` - Facilitator client (13 tests)
- `tests/server/x402-facilitator-validation.test.ts` - Payload validation (13 tests)
- `tests/server/x402-codes-and-idempotency.test.ts` - Error codes + replay (36 tests)
- `tests/client/submit-402-flow.test.ts` - Client-side flow (17 tests)
- `tests/client/x402-parse.test.ts` - X-PAYMENT header parsing (30 tests)

**Total x402 Test Coverage:** ~129 tests (passing)

---

## 11. Smoke Test Instructions

See deliverables:
- `scripts/x402/check-rpc.ts` - Verify Base Sepolia RPC connectivity
- `scripts/x402/price-quote.ts` - Test price quote endpoint
- `scripts/x402/simulate-verify.sh` - Demonstrate verify flow with mock data

**Quick Start:**
```bash
# 1. Check RPC connection
npm run x402:check-rpc

# 2. Get price quote
npm run x402:price-quote

# 3. Simulate verify (requires test data)
./scripts/x402/simulate-verify.sh http://localhost:3000
```

---

## Appendix A: Database ER Diagram

```
tracks
├── id (PK)
├── user_id (FK → users)
├── payer_user_id (FK → users, nullable)
├── status (PENDING_PAYMENT | PAID | ...)
├── price_usd
├── x402_payment_tx
└── x402_challenge_* (backward compat)

payment_challenges
├── challenge_id (PK)
├── track_id (FK → tracks, cascade)
├── user_id (FK → users)
├── amount_atomic
├── nonce (unique per challenge)
├── expires_at
└── confirmed_at (nullable)

payment_confirmations
├── id (PK)
├── challenge_id (FK → payment_challenges, unique)
├── tx_hash (unique across all confirmations)
├── provider
└── amount_paid_atomic

Idempotency Constraints:
1. payment_confirmations.challenge_id UNIQUE → One confirmation per challenge
2. payment_confirmations.tx_hash UNIQUE → One tx cannot confirm multiple challenges
```

---

## Appendix B: Glossary

**x402:** HTTP status code 402 "Payment Required" + protocol for on-chain payments
**ERC-3009:** Ethereum standard for transferWithAuthorization (meta-transactions)
**Facilitator:** External service that validates signatures without requiring on-chain TX
**PKCE:** Proof Key for Code Exchange (OAuth security, not directly used here)
**Nonce:** Number used once, prevents signature replay
**Challenge:** Server-generated payment request with amount/recipient/expiry
**Authorization:** Signed ERC-3009 payload from user wallet
**TTL:** Time To Live (10 minutes default for challenges)
**Atomic Units:** Smallest denomination (e.g., wei for ETH, 1e-18)
**Idempotency:** Property where duplicate requests yield same result
**Clock Skew:** Difference between server/client time (±60s tolerance)

---

**End of Audit Report**
**Generated:** 2025-10-27
**Author:** Claude Code (automated codebase analysis)
**Next Review:** Before mainnet launch
